---
title: "Subnational Probabilistic Population Projections"
author: Hana Sevcikova
date: 2024-01-04
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{population-projections}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
download_data <- FALSE
```

In this vignette we will show how **bayesPop** can be used in subnational settings, using annual 1x1 data. We will use example data for the US states to demonstrate the various functionalities. For instructions how to use **bayesPop** to generate national projections, see [Ševčíková and Raftery (2016)](https://www.jstatsoft.org/article/view/v075i05).

To organize our work, let's set up a working directory for all inputs and outputs:

```{r eval = FALSE, include = TRUE}
wrk_dir <- "bayesPopSubnatProj"
```

```{r eval = !download_data, include = FALSE}
wrk_dir <- "/Users/hana/bayespop/R/Pop/subnat/bayesPopSubnatProj"
```

```{r eval = download_data, include = FALSE}
wrk_dir <- tempdir()
```

# Downloading Data

Next, set a directory to hold the input data and create it if it does not exist:

```{r eval = TRUE, include = TRUE}
data_dir <- file.path(wrk_dir, "inputs")
```

```{r eval = TRUE, include = TRUE}
if(!dir.exists(data_dir))
    dir.create(data_dir)
```

## Subnational example data

The subnational data needed to follow examples in this vignette are in the GitHub repository ["PPgp/bayesPopUSdata"](https://github.com/PPgp/bayesPopUSdata) and can be downloaded as follows:

```{r eval = download_data, include = TRUE}
# This will work after the repo is made public
repo_file <- file.path(data_dir, "main.zip")
download.file("https://github.com/PPgp/bayesPopUSdata/archive/refs/heads/main.zip", repo_file)
unzip(repo_file, exdir = data_dir)
unlink(repo_file)
```

It creates a directory "bayesPopUSdata-main" which contains text files with total fertility rates ("US_states_tfr.txt"), sex-specific life expectancy at birth ("US_states_e0F.txt", "US_states_e0M.txt"), net migration rates ("US_states_migrate.txt"), and percent age-specific fertility ("US_states_pasfr.txt").

## National projections

To project subnational total fertility rate (TFR) and life expectancy at birth ($e_0$) we will need probabilistic national projections of the corresponding country. Such projections, generated using the **bayesTFR** and **bayesLife** R packages, which align well with the United Nations projections published in the World Population Prospects can be downloaded from [our website](https://bayespop.csss.washington.edu/download) as follows:

```{r eval = download_data, include = TRUE}
options(timeout = 600)
tfr_world_file <- file.path(data_dir, "TFR1simWPP2022.tgz")
download.file("https://bayespop.csss.washington.edu/data/bayesTFR/TFR1simWPP2022.tgz", tfr_world_file)
err <- untar(tfr_world_file, exdir = data_dir)
if(err == 0) unlink(tfr_world_file)

e0_world_file <- file.path(data_dir, "e01simWPP2022.tgz")
download.file("https://bayespop.csss.washington.edu/data/bayesLife/e01simWPP2022.tgz", e0_world_file)
err <- untar(e0_world_file, exdir = data_dir)
if(err == 0) unlink(e0_world_file)
```
Note that if you are on a slow network and get a timeout error, you might want to increase the `timeout` option.

# Outline

To generate probabilistic population projections for all US states, we will proceed in the following steps:

1. Generate future trajectories of total fertility rates
2. Generate future trajectories of life expectancy at birth for female and male
3. Generate future trajectories of net migration rates
4. Generate future trajectories of age and sex-specific population

Results of each of the steps will be stored in its own directory in the parent working directory `wrk_dir`.

We will work with four R packages, namely **bayesTFR**, **bayesLife**, **bayesMig**, and **bayesPop**. Loading **bayesPop** pulls also the first two packages into the namespace. Thus, loading the last two packages will be sufficient.

```{r eval = TRUE, results = FALSE}
library(bayesPop)
library(bayesMig)
```

# Total Fertility Rate

The probabilistic projection of subnational TFR is generated using the methodology by [Ševčíková et al. (2018)](https://www.demographic-research.org/volumes/vol38/60/default.htm) and implemented in  the **bayesTFR** package. It is based on the idea that TFR in sub-national units closely follow the corresponding national projections. Thus, we base our projections on the US probabilistic projections that approximate the United Nations' official projections from the [World Population Prospects 2022](https://population.un.org/wpp) (UN WPP 2022). These projections which we downloaded in the previous step were generated using the methodology and software described in [Liu et al. (2023)](https://doi.org/10.18637/jss.v106.i08). 

The directory pointing to these national projections for all countries of the world is 

```{r eval = TRUE, include = TRUE}
world_dir_tfr <- file.path(data_dir, "TFR1unc", "sim20221027")
```

One can explore the US projections with various functions from the **bayesTFR** package. For example as a graph:

```{r eval = TRUE, include = TRUE, fig.width = 7, fig.height = 5, fig.align='center'}
tfr_world_pred <- get.tfr.prediction(world_dir_tfr)
tfr.trajectories.plot(tfr_world_pred, country = "USA", nr.traj = 50, half.child.variant = FALSE,
                      uncertainty = TRUE)

```

Here, for the `country` argument the ISO-3 code is used. An ISO-2 or a numerical UN code (which is 840 for the US) is also accepted. In addition to the predictive distribution (shown as grey trajectories) with its probability intervals (shown as red lines), the graph also shows uncertainty around the observed data (controlled by the argument `uncertainty`), which is in the case of the US very narrow. Numerical values from this graph can be seen using the function `tfr.trajectories.table()`. For more information on how to explore such national projections see [Liu et al. (2023)](https://doi.org/10.18637/jss.v106.i08).

To generate subnational projections for the US states, we will use observed data in "US_states_tfr.txt" that we downloaded above.

```{r eval=TRUE, include=TRUE}
tfr_subnat_file <- file.path(data_dir, "bayesPopUSdata-main", "US_states_tfr.txt")
read.table(tfr_subnat_file, sep= "\t", header = TRUE, check.names = FALSE) |> head()
```

It contains TFR for all US states and territories, from 2008 to 2021. A unique identifier of the regions is given by the column "reg_code". The column "country_code" defines the corresponding country, here 840 for the US. The column "include_code" specifies if the region should be included in the prediction (value 2) or not (value 0). Note that the data can contain missing values at the beginning or the end of the time series, as shown here for American Samoa from 2018 to 2021.

The subnational TFR predictions will be stored in the sub-directory "tfr" of our working directory:
```{r eval=TRUE, include=TRUE}
dir_tfr <- file.path(wrk_dir, "tfr")
```

We decide on how many trajectories we'd like to generate. The more trajectories, the smoother the results, but the longer the processing time. One can also choose the same number as the national simulation (in our case 1000), obtained via `summary(tfr_world_pred)`. To keep the processing time low, for this example we choose 50 trajectories. However, this would not be sufficient in a real world simulation.

```{r}
nr_traj <- 50
```

To launch the predictions, we use the function `tfr.predict.subnat()`:

```{r eval=TRUE, include=TRUE, results = FALSE}
tfr_pred <- tfr.predict.subnat(countries = 840, sim.dir = world_dir_tfr, output.dir = dir_tfr,
                               annual = TRUE, end.year = 2050, nr.traj = nr_traj, 
                               verbose = TRUE, my.tfr.file = tfr_subnat_file
                               )
```

Here, we are directing the function to generate `r nr_traj`  trajectories of future annual TFR until 2050 for regions found in the file given by argument `my.tfr.dir`, that is for regions that belong to country 840 (i.e. the US). Argument `annual` determines that the function expects annual subnational data, as oppose to 5-year data. Argument `sim.dir` points to the national projections, while argument `output.dir` determines where the results are stored.

Since the `tfr.predict.subnat()` function allows to run predictions for multiple countries at once (given by the vector `countries`), the return value is a list with names corresponding to the country codes. Thus, to extract the list item for the US, we do:

```{r}
tfr_pred_us <- tfr_pred[["840"]]
```

Alternatively, if the predictions are accessed at a later time point, one can obtain the same object by pointing to the simulation directory: 

```{r}
tfr_pred_us <- get.regtfr.prediction(dir_tfr, country = 840)
```

Now various **bayesTFR** functions for analyzing results can be used. For example, to view the projected TFR for four different regions, do:


```{r eval=TRUE, include=TRUE, fig.width = 7, fig.height = 7, fig.align='center'}
par(mfrow = c(2,2))
for (loc in c("Vermont", "California", "South Dakota", "American Samoa")){
  tfr.trajectories.plot(tfr_pred_us, loc, half.child = FALSE, nr.traj = 30, pi = 95) 
  abline(h = 2.1, col = "grey")
}
```

In each graph, we have also drawn a gray line at the replacement level of 2.1. One can see that while Vermont and California have a small probability that TFR will reach the replacement level before 2050, for South Dakota and American Samoa there is a very high probability that TFR will not get far below the replacement level. 

If the observed data contain missing values at the end of the time series, these data points are automatically imputed by jumping off the prediction from the latest non-missing time point and using the median of the projection as imputed values. This is the case of American Samoa, where prediction jumped off from 2017. Then the time period from 2018 to 2021 was imputed by using the median of the predictive distribution. These imputed points are shown as green dots in the figure.

Tabular results can be viewed using either the `summary()` function which returns among others the mean and standard deviation, or the `tfr.trajectories.table()` function which can return any quantile of interest:

```{r}
tfr.trajectories.table(tfr_pred_us, "Washington") |> tail()
```

Note that since the **bayesTFR** package was originally designed to work on the national level, many functions accept the argument `country` or have "country/ies" in its name. When using in the subnational context, country means a region. For example, to view all regions included in the projection, including their codes, one can use:

```{r}
get.countries.table(tfr_pred_us) |> head()
```

Or, to obtain the code or index of a specific region:

```{r}
get.country.object("Nebraska", country.table = get.countries.table(tfr_pred_us))
```
Similarly, searching by code or index:

```{r results = FALSE}
get.country.object(43, country.table = get.countries.table(tfr_pred_us))
get.country.object(46, country.table = get.countries.table(tfr_pred_us), index = TRUE)
```

The working directory now should contain a sub-directory "tfr" that contains a directory "subnat/c840" which holds the prediction info and trajectories for each region. 

# Life Expectancy at Birth

The probabilistic projections of subnational life expectancy at birth ($e_0$) is generated using the methodology of [Ševčíková and Raftery (2021)](https://sciendo.com/article/10.2478/jos-2021-0027) which is implemented in the **bayesLife** package. Similarly to modeling subnational fertility, $e_0$ in subnational units can be also modeled by following closely the national projections, in our case the probabilistic projections of the US $e_0$ which we generated to approximate the [UN WPP 2022](https://population.un.org/wpp) and which we downloaded previously. They were produced using the methodology of [Raftery et al. (2013)](http://link.springer.com/content/pdf/10.1007%2Fs13524-012-0193-x.pdf).

As in the national case, we first project female $e_0$. Then the male $e_0$ is projected using the gap model as described in [Raftery et al. (2014)](http://www.demographic-research.org/volumes/vol30/27/30-27.pdf).

The directory pointing to the national $e_0$ projections for all countries is 

```{r eval = TRUE, include = TRUE}
world_dir_e0 <- file.path(data_dir, "e01", "sim20230204")
```

To explore the US projections one can use various functions from the **bayesLife** package. For example:

```{r eval = TRUE, include = TRUE, fig.width = 7, fig.height = 5, fig.align='center'}
e0_world_pred <- get.e0.prediction(world_dir_e0)
e0.trajectories.plot(e0_world_pred, country = "USA", nr.traj = 50, both.sexes = TRUE)
```

For subnational observed data we will use the two files we downloaded earlier, one for female and one for male.

```{r eval=TRUE, include=TRUE}
e0F_subnat_file <- file.path(data_dir, "bayesPopUSdata-main", "US_states_e0F.txt")
e0M_subnat_file <- file.path(data_dir, "bayesPopUSdata-main", "US_states_e0M.txt")
read.table(e0F_subnat_file, sep= "\t", header = TRUE, check.names = FALSE) |> head()
```

For each state and territory, the files contain $e_0$ from 2018 through 2020. The meaning of the remaining columns (`reg_code`, `country_code`, `include_code`) is the same as in the case of TFR. Here we don't have any missing values per se, however, since the last observed year for TFR as well as for the national $e_0$ simulation is 2021, we will treat the year 2021 as missing $e_0$ for all states and let the simulation to automatically impute it. This will be handled the same way as for TFR, namely by jumping into the simulation from 2020 and replacing the missing 2021 values with the projected medians for that year.

We set the directory for storing the subnational prediction of $e_0$ to "e0", located inside the main working directory:

```{r eval=TRUE, include=TRUE}
dir_e0 <- file.path(wrk_dir, "e0")
```

Now we can launch the $e_0$ predictions:

```{r eval=TRUE, include=TRUE, results = FALSE}
e0_pred <- e0.predict.subnat(countries = 840, sim.dir= world_dir_e0, output.dir = dir_e0,
                             annual = TRUE, end.year = 2050, nr.traj = nr_traj,
                             my.e0.file = e0F_subnat_file, 
                             predict.jmale = TRUE, my.e0M.file = e0M_subnat_file
                             )
```

Here, we are generating `r nr_traj` trajectories of annual future $e_0$ until 2050 using data found in the file given by the `my.e0.file` argument, which in our case is female $e_0$. However, setting the argument `predict.jmale` to `TRUE`, we are directing the function to also predict male $e_0$ by applying the female-male gap using the male $e_0$ found in the file given by the `my.e0M.file` argument. 

As in the TFR case, the resulting object from the above call is a list and we can extract the US results by

```{r}
e0_pred_us <- e0_pred[["840"]]
```

Or, if the predictions are accessed at a later time point: 

```{r}
e0_pred_us <- get.rege0.prediction(dir_e0, country = 840)
```

For analyzing results, various **bayesLife** functions can be used. Here for two states, we view the projected marginal $e_0$ for both sexes, using the national female projections as a background for a comparison:


```{r eval=TRUE, include=TRUE, fig.width = 7, fig.height = 4, fig.align='center'}
par(mfrow = c(1,2))
for (loc in c("Washington", "Mississippi")){
  # plot the national female projections in grey
  e0.trajectories.plot(e0_world_pred, country = "USA", nr.traj = 0, 
                       xlim = c(1970, 2050), ylim = c(65, 92), pi = 80, 
                       show.legend = FALSE, main = loc, col = rep("grey", 4))
  # add sub-national projections
  e0.trajectories.plot(e0_pred_us, loc, nr.traj = 0, pi = 95, 
                       both.sexes = TRUE, add = TRUE, show.legend = FALSE)
  legend("topleft", legend = c("female", "male", "US female", "median", "80% PI", "imputed"),
         bty = "n", col = c("pink", "darkgreen", "grey", "black", "black", "green"),
                    lty = c(1, 1, 1, 1, 2, 1), lwd = 2, cex = 0.7)
}
```

One can see that there is one imputed value for both, the female and male projections, namely for 2021. 

This marginal distribution may suggest that crossovers between female and male $e_0$ are possible. However, when viewing the joint distribution between male and female, here for three different years, it is obvious that it is not the case:

```{r eval=TRUE, include=TRUE, fig.width = 7, fig.height = 4, fig.align='center'}
par(mfrow = c(1,2))
for (loc in c("Washington", "Mississippi"))
  e0.joint.plot(e0_pred_us, loc, years = c(2022, 2035, 2050), 
                xlim = c(65, 95), ylim = c(65, 95))
```

Functions `e0.trajectories.table()` and `summary()` can be used to explore tabular results. When passing the `e0_pred_us` object to them, the operation is performed on the female prediction object. To retrieve the male prediction object, do one of the following:

```{r eval=TRUE}
e0M_pred_us <- get.e0.prediction(dir_e0, joint.male = TRUE)  # or
e0M_pred_us <- get.e0.jmale.prediction(e0_pred_us)
```

To retrieve the values of all male trajectories, for example for Mississippi, do

```{r eval=TRUE}
trajMiss <- get.e0.trajectories(e0M_pred_us, "Mississippi")
```

It is an array of time x trajectories. These can be used to create other summaries, or for computing various probabilities. For example, what is the probability that Mississippi's male $e_0$ by 2050 reaches the 2021 national value of 74.3?

```{r eval=TRUE}
sum(trajMiss["2050", ] >= 74.3)/ncol(trajMiss) * 100
```

Note that the 2021 male national $e_0$ was retrieved via
```{r eval=TRUE}
e0M_world_pred <- get.e0.jmale.prediction(e0_world_pred)
e0.trajectories.table(e0M_world_pred, "USA")["2021", "median"]
```


# Migration

In this step, we will generate probabilistic projection of net migration rates (NMR) for all states, using the **bayesMig** package. First, we will use our example historical data (downloaded above) to estimate the Bayesian hierarchical (BHM) model by  [Azose and Raftery (2015)](http://link.springer.com/article/10.1007/s13524-015-0415-0).

The units in our historical estimates are the number of migrants per 1000 people. Here are the first few lines in that dataset:

```{r eval=TRUE}
mig_subnat_file <- file.path(data_dir, "bayesPopUSdata-main", "US_states_migrate.txt")
mig_data <- read.table(mig_subnat_file, sep= "\t", header = TRUE, check.names = FALSE)
head(mig_data)
```

The methodology and the **bayesMig** package itself have been designed for a model hierarchy of countries -> world. However, we found that the model also works well when applied to sub-national units, in our case using the hierarchy US states -> US. Thus, when using within **bayesMig** we are pretending that the US states are countries and call the unique identifier `country_code`. The `include_code` column specifies if the corresponding location should be included in the BHM and its data should influence the global parameters (value 2), or if only location-specific parameters will be estimated using the global experience without back-influencing it (value 1), or not be included at all (value 0). The second case (value 1) is to be used for locations with unusual patterns, or simply for very small locations without a representative historical experience. In our dataset we set `include_code` to 2 for all sates and to 1 for all territories. 

```{r eval=TRUE}
subset(mig_data, include_code == 1)[, 1:2]
```

To estimate the model to derive state-level parameters, we will run Markov Chain Monte Carlo (MCMC) for which we set the number of iterations per chain and the number of chains:

```{r eval=TRUE}
mig_iter <- 250
mig_nr_chains <- 2
```

Normally in a real-world example, about 3 x 50,000 iterations would be needed. For our toy example, we will only iterate `r mig_nr_chains` x `r mig_iter` times. The simulation results will be stored in the sub-directory "mig" of our working directory:

```{r eval=TRUE, include=TRUE}
dir_mig <- file.path(wrk_dir, "mig")
```

```{r eval=TRUE, include = FALSE}
if(dir.exists(dir_mig)) unlink(dir_mig, recursive = TRUE)
```

To launch the MCMCs with these settings, we use the function `run.mig.mcmc()` as follows:

```{r eval=TRUE, results = FALSE}
mig_mcmc <- run.mig.mcmc(nr.chains = mig_nr_chains, iter = mig_iter, 
                         output.dir = dir_mig, my.mig.file = mig_subnat_file,
                         annual = TRUE, pop.denom = 1000)
```

The `pop.denom` argument tells the model that the denominator in our historical dataset is 1000. If the units were migrants per person, we would use the default of `pop.denom = 1`. 

The function also accepts an argument `exclude.from.world`. This can be used in addition to the `include_code` column to explicitly specify additional locations to be excluded from influencing the global parameters. For example, to exclude all territories and Rhode Island, one could use `exclude.from.world = 43`. The function `get.countries.table(mig_mcmc)` can help to see the location codes. States excluded from influencing the global parameters are sorted at the end of that list. In [Yu et al. (2023)](https://doi.org/10.1215/00703370-10772782) which generates population projections for all counties in the Washington State, all counties below population of 25,000 were passed to the `exclude.from.world` argument.

An optional argument `start.year` could be used to limit the time span of the observed data used for the estimation. Here we use all available data from 2010 to 2021.

Now various **bayesMig** functions can be used to explore the results of the estimation. For example, `mig.partraces.plot(mig_mcmc, burnin = 100)` for plotting the traces of global parameters, or `mig.partraces.cs.plot` for traces of the state-specific parameters. See `?bayesMig` for more info.

We will now use the MCMC results which are stored in `dir_mig` to generate future trajectories of NMR for each state from 2022 to 2050:

```{r eval=TRUE, results = FALSE}
mig_pred <- mig.predict(sim.dir = dir_mig, end.year = 2050, 
                        nr.traj = nr_traj, burnin = 100,
                        save.as.ascii = nr_traj)
```

We are using the same number of trajectories as for TFR and $e_0$, namely `r nr_traj` while discarding first 100 iterations from each chain as burnin. Note that after applying the burnin, our toy MCMCs will contain `r mig_nr_chains` x (`r mig_iter` - 100) = `r mig_nr_chains*(mig_iter - 100)` iterations. These will be then collapsed and thinned by `r mig_nr_chains*(mig_iter - 100)/nr_traj` to yield `r nr_traj` trajectories. In a real-world simulation with 3 x 50,000 iterations, we would recommend to use about 20,000 burnin.

The last option, `save.as.ascii`, causes that the projection directory "{dir_mig}/predictions" contains a file called "ascii_trajectories.csv" which will be used as input to the population projection in the next section.

To retrieve the MCMC object and the prediction from disk, for example at later time, one can use:

```{r eval=TRUE}
mig_mcmc <- get.mig.mcmc(dir_mig)
mig_pred <- get.mig.prediction(dir_mig)
```

As in the case of TFR and $e_0$, various functions can be used to analyze the prediction, for example as plots:

```{r eval=TRUE, fig.width = 6, fig.height = 4.5, fig.align='center'}
mig.trajectories.plot(mig_pred, "Washington", nr.traj = 20)
```

One can see that for Washington, the NMR is projected likely to be positive, which is in line with the historical experience. However, the results of this toy example do not exclude the possibility of having negative net migration in Washington. 


# Population

The inputs for probabilistic population projections consist of the three **probabilistic components** we just generated, namely future 

* TFR
* male and female $e_0$  
* net migration

In addition, the following **deterministic datasets** are needed, most of which we downloaded in the first section:

* initial population estimates
* historical estimates of sex- and age-specific mortality rates
* historical estimates of percent age-specific fertility (file "US_states_pasfr.txt")
* historical estimates of sex-ratio at birth



# References

Azose, J.J. and Raftery, A.E. (2015). [Bayesian Probabilistic Projection of International Migration Rates](http://link.springer.com/article/10.1007/s13524-015-0415-0). Demography 52:1627-1650.

Liu, P.R., Ševčíková, H., and Raftery, A.E. (2023) [Probabilistic Estimation and Projection of the Annual Total Fertility Rate Accounting for Past Uncertainty](https://doi.org/10.18637/jss.v106.i08). Journal of Statistical Software, Vol. 106(8).

Raftery, A.E., Chunn, J.L., Gerland, P. and Ševčíková , H. (2013). [Bayesian Probabilistic Projections of Life Expectancy for All Countries](http://link.springer.com/content/pdf/10.1007%2Fs13524-012-0193-x.pdf). Demography, 50:777-801.

Raftery, A.E., Lalic, N. and Gerland, P. (2014). [Joint Probabilistic Projection of Female and Male Life Expectancy](http://www.demographic-research.org/volumes/vol30/27/30-27.pdf). Demographic Research, 30:795-822.

Ševčíková, H. and Raftery, A.E. (2016). [bayesPop: Probabilistic Population Projections](https://www.jstatsoft.org/article/view/v075i05). Journal of Statistical Software, Vol. 75(5).

Ševčíková, H. and Raftery, A.E. (2021). [Probabilistic Projection of Subnational Life Expectancy](https://sciendo.com/article/10.2478/jos-2021-0027). Journal of Official Statistics, Vol. 37, no. 3, 591-610.

Ševčíková, H., Raftery, A.E. and Gerland, P. (2018). [Probabilistic projection of subnational total fertility rates](https://www.demographic-research.org/volumes/vol38/60/default.htm). Demographic Research, Vol. 38(60): 1843-1884.

Yu, C., Ševčíková, H., Raftery, A.E., and Curran, S.R. (2023). [Probabilistic County-Level Population Projections](https://doi.org/10.1215/00703370-10772782). Demography, Vol. 60(3): 915-937.
